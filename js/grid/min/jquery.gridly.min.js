(function(){"use strict";var t,i,e,n,s=function(t,i){return function(){return t.apply(i,arguments)}},o=[].slice;t=jQuery,i=function(){function t(){}return t.transitions={webkitTransition:"webkitTransitionEnd",mozTransition:"mozTransitionEnd",oTransition:"oTransitionEnd",transition:"transitionend"},t.transition=function(t){var i,e,n,s;i=t[0],s=this.transitions;for(n in s)if(e=s[n],null!=i.style[n])return e},t.execute=function(t,i){var e;return e=this.transition(t),null!=e?t.one(e,i):i()},t}(),e=function(){function i(t,i,e){this.click=s(this.click,this),this.moved=s(this.moved,this),this.ended=s(this.ended,this),this.began=s(this.began,this),this.coordinate=s(this.coordinate,this),this.off=s(this.off,this),this.on=s(this.on,this),this.toggle=s(this.toggle,this),this.bind=s(this.bind,this),this.$container=t,this.selector=i,this.callbacks=e,this.toggle()}return i.prototype.bind=function(i){return null==i&&(i="on"),t(document)[i]("mousemove touchmove",this.moved),t(document)[i]("mouseup touchend touchcancel",this.ended)},i.prototype.toggle=function(t){return null==t&&(t="on"),this.$container[t]("mousedown touchstart",this.selector,this.began),this.$container[t]("click",this.selector,this.click)},i.prototype.on=function(){return this.toggle("on")},i.prototype.off=function(){return this.toggle("off")},i.prototype.coordinate=function(t){switch(t.type){case"touchstart":case"touchmove":case"touchend":case"touchcancel":return t.originalEvent.touches[0];default:return t}},i.prototype.began=function(i){var e;if(!this.$target)return i.preventDefault(),i.stopPropagation(),this.bind("on"),this.$target=t(i.target).closest(this.$container.find(this.selector)),this.$target.addClass("dragging"),this.origin={x:this.coordinate(i).pageX-this.$target.position().left,y:this.coordinate(i).pageY-this.$target.position().top},null!=(e=this.callbacks)?"function"==typeof e.began?e.began(i):void 0:void 0},i.prototype.ended=function(t){var i;if(null!=this.$target)return t.preventDefault(),t.stopPropagation(),this.bind("off"),this.$target.removeClass("dragging"),delete this.$target,delete this.origin,null!=(i=this.callbacks)?"function"==typeof i.ended?i.ended(t):void 0:void 0},i.prototype.moved=function(t){var i;if(null!=this.$target)return t.preventDefault(),t.stopPropagation(),this.$target.css({left:this.coordinate(t).pageX-this.origin.x,top:this.coordinate(t).pageY-this.origin.y}),this.dragged=this.$target,null!=(i=this.callbacks)?"function"==typeof i.moved?i.moved(t):void 0:void 0},i.prototype.click=function(t){return this.dragged?(t.preventDefault(),t.stopPropagation(),delete this.dragged):void 0},i}(),n=function(){function i(e,n){return null==n&&(n={}),this.optimize=s(this.optimize,this),this.layout=s(this.layout,this),this.structure=s(this.structure,this),this.position=s(this.position,this),this.size=s(this.size,this),this.draggingMoved=s(this.draggingMoved,this),this.draggingEnded=s(this.draggingEnded,this),this.draggingBegan=s(this.draggingBegan,this),this.$sorted=s(this.$sorted,this),this.draggable=s(this.draggable,this),this.compare=s(this.compare,this),this.$=s(this.$,this),this.reordinalize=s(this.reordinalize,this),this.ordinalize=s(this.ordinalize,this),this.$el=e,this.settings=t.extend({},i.settings,n),this.ordinalize(this.$("> *")),this.settings.draggable!==!1&&this.draggable(),this}return i.settings={base:60,gutter:20,columns:12,draggable:{zIndex:800}},i.gridly=function(t,e){var n;return null==e&&(e={}),n=t.data("_gridly"),n||(n=new i(t,e),t.data("_gridly",n)),n},i.prototype.ordinalize=function(i){var e,n,s,o,r;for(r=[],n=s=0,o=i.length;o>=0?o>=s:s>=o;n=o>=0?++s:--s)e=t(i[n]),r.push(e.data("position",n));return r},i.prototype.reordinalize=function(t,i){return t.data("position",i)},i.prototype.$=function(t){return this.$el.find(t)},i.prototype.compare=function(t,i){return t.y>i.y+i.h?1:i.y>t.y+t.h?-1:t.x+t.w/2>i.x+i.w/2?1:i.x+i.w/2>t.x+t.w/2?-1:0},i.prototype.draggable=function(t){return null==this._draggable&&(this._draggable=new e(this.$el,"> *",{began:this.draggingBegan,ended:this.draggingEnded,moved:this.draggingMoved})),null!=t?this._draggable[t]():void 0},i.prototype.$sorted=function(i){return(i||this.$("> *")).sort(function(i,e){var n,s,o,r,h,a;return n=t(i),s=t(e),o=n.data("position"),h=s.data("position"),r=parseInt(o),a=parseInt(h),null!=o&&null==h?-1:null!=h&&null==o?1:!o&&!h&&n.index()<s.index()?-1:!h&&!o&&s.index()<n.index()?1:a>r?-1:r>a?1:0})},i.prototype.draggingBegan=function(){var t,i,e;return t=this.$sorted(),this.ordinalize(t),setTimeout(this.layout,0),null!=(i=this.settings)?null!=(e=i.callbacks)?"function"==typeof e.reordering?e.reordering(t):void 0:void 0:void 0},i.prototype.draggingEnded=function(){var t,i,e;return t=this.$sorted(),this.ordinalize(t),setTimeout(this.layout,0),null!=(i=this.settings)?null!=(e=i.callbacks)?"function"==typeof e.reordered?e.reordered(t):void 0:void 0:void 0},i.prototype.draggingMoved=function(i){var e,n,s,o,r,h,a,g,u,l,d,c,p;for(e=t(i.target).closest(this.$("> *")),n=this.$sorted(),a=this.structure(n).positions,h=r=e.data("position"),d=a.filter(function(t){return t.$element.is(e)}),g=0,l=d.length;l>g;g++)s=d[g],s.x=e.position().left,s.y=e.position().top,s.w=e.data("width")||e.width(),s.h=e.data("height")||e.height();for(a.sort(this.compare),n=a.map(function(t){return t.$element}),n=((null!=(c=this.settings.callbacks)?c.optimize:void 0)||this.optimize)(n),o=u=0,p=n.length;p>=0?p>u:u>p;o=p>=0?++u:--u)this.reordinalize(t(n[o]),o);return this.layout()},i.prototype.size=function(t){return((t.data("width")||t.width())+this.settings.gutter)/(this.settings.base+this.settings.gutter)},i.prototype.position=function(t,i){var e,n,s,o,r,h,a,g,u;for(r=this.size(t),n=1/0,e=0,s=h=0,g=i.length-r;g>=0?g>h:h>g;s=g>=0?++h:--h)o=Math.max.apply(Math,i.slice(s,s+r)),n>o&&(n=o,e=s);for(s=a=e,u=e+r;u>=e?u>a:a>u;s=u>=e?++a:--a)i[s]=n+(t.data("height")||t.height())+this.settings.gutter;return{x:e*(this.settings.base+this.settings.gutter),y:n}},i.prototype.structure=function(i){var e,n,s,o,r,h,a,g;for(null==i&&(i=this.$sorted()),h=[],n=function(){var t,i,e;for(e=[],s=t=0,i=this.settings.columns;i>=0?i>=t:t>=i;s=i>=0?++t:--t)e.push(0);return e}.call(this),o=a=0,g=i.length;g>=0?g>a:a>g;o=g>=0?++a:--a)e=t(i[o]),r=this.position(e,n),h.push({x:r.x,y:r.y,w:e.data("width")||e.width(),h:e.data("height")||e.height(),$element:e});return{height:Math.max.apply(Math,n),positions:h}},i.prototype.layout=function(){var i,e,n,s,o,r,h,a;for(e=((null!=(h=this.settings.callbacks)?h.optimize:void 0)||this.optimize)(this.$sorted()),o=this.structure(e),n=r=0,a=e.length;a>=0?a>r:r>a;n=a>=0?++r:--r)i=t(e[n]),s=o.positions[n],i.is(".dragging")||i.css({position:"absolute",left:s.x,top:s.y});return this.$el.css({height:o.height})},i.prototype.optimize=function(i){var e,n,s,o,r;for(s=[],e=0;i.length>0;){for(e===this.settings.columns&&(e=0),n=0,n=o=0,r=i.length;(r>=0?r>o:o>r)&&!(e+this.size(t(i[n]))<=this.settings.columns);n=r>=0?++o:--o);n===i.length&&(n=0,e=0),e+=this.size(t(i[n])),s.push(i.splice(n,1)[0])}return s},i}(),t.fn.extend({gridly:function(){var i,e;return i=arguments[0],e=2<=arguments.length?o.call(arguments,1):[],null==i&&(i={}),this.each(function(){var s,o,r;return s=t(this),r=t.extend({},t.fn.gridly.defaults,"object"==typeof i&&i),o="string"==typeof i?i:i.action,null==o&&(o="layout"),n.gridly(s,r)[o](e)})}})}).call(this);